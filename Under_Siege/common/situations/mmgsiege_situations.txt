mmgsiege_siege_surrender_attacker_situation = {
	picture = GFX_evt_burning_city
	category = positive
	fail_icon = GFX_situation_outcome_meh
	fail_icon_frame = GFX_situation_outcome_frame
	complete_icon = GFX_situation_outcome_positive
	complete_icon_frame = GFX_situation_outcome_frame_green
	abort_trigger = {
		OR = {
			target = {
				mmgsiege_planet_can_surrender = no
			}
			NOT = {
				exists = target.solar_system.starbase
				target.solar_system.starbase.controller = {
					is_same_value = root.owner
				}
			}
		}
	}
	on_fail = {
		# handled by defender situation
	}
	on_progress_complete = {
		# handled by defender situation
		custom_tooltip = mmgsiege_siege_surrender_attacker_situation_outcome_effect
	}
	stages = {
		mmgsiege_siege_surrender_situation_stage_1 = {
			end = 25
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_green
		}
		mmgsiege_siege_surrender_situation_stage_2 = {
			end = 50
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_green
		}
		mmgsiege_siege_surrender_situation_stage_3 = {
			end = 75
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_green
		}
		mmgsiege_siege_surrender_situation_stage_4 = {
			end = 100
			icon = GFX_situation_stage_4
			icon_background = GFX_situation_stage_frame_green
		}
	}
	approach = {
		name = mmgsiege_siege_approach_do_nothing
		icon = GFX_situation_approach_this_is_fine
		icon_background = GFX_situation_approach_bg_yellow
		default = yes
		on_select = {
			custom_tooltip = mmgsiege_siege_approach_do_nothing
		}
		ai_weight = {
			weight = 10
		}
	}
	approach = {
		name = mmgsiege_siege_approach_attacker_propaganda
		icon = GFX_situation_approach_influence
		icon_background = GFX_situation_approach_bg_green
		resources = {
			category = situations
			upkeep = {
				influence = 0.25
				trigger = {
					target = {
						num_pops < 10
					}
				}
			}
			upkeep = {
				influence = 0.5
				trigger = {
					target = {
						num_pops >= 10
						num_pops < 25
					}
				}
			}
			upkeep = {
				influence = 0.75
				trigger = {
					target = {
						num_pops >= 25
						num_pops < 50
					}
				}
			}
			upkeep = {
				influence = 1
				trigger = {
					target = {
						num_pops >= 50
					}
				}
			}
		}
		on_select = {
			custom_tooltip = mmgsiege_siege_approach_attacker_propaganda_tooltip
		}
		ai_weight = {
			weight = 5
			modifier = {
				add = 10
				owner = {
					has_claim = root.target.solar_system
				}
			}
			modifier = {
				factor = 0
				owner = {
					has_deficit = influence
				}
			}
		}
	}
	monthly_progress = {
		base = 0
		modifier = {
			add = 1
			desc = planet_stability_low
			target = {
				planet_stability < 40
				planet_stability >= 35
			}
		}
		modifier = {
			add = 2
			desc = planet_stability_low
			target = {
				planet_stability < 35
				planet_stability >= 30
			}
		}
		modifier = {
			add = 3
			desc = planet_stability_low
			target = {
				planet_stability < 30
				planet_stability >= 25
			}
		}
		modifier = {
			add = 4
			desc = planet_stability_low
			target = {
				planet_stability < 25
				planet_stability >= 20
			}
		}
		modifier = {
			add = 5
			desc = planet_stability_low
			target = {
				planet_stability < 20
				planet_stability >= 15
			}
		}
		modifier = {
			add = 6
			desc = planet_stability_low
			target = {
				planet_stability < 15
				planet_stability >= 10
			}
		}
		modifier = {
			add = 7
			desc = planet_stability_low
			target = {
				planet_stability < 10
				planet_stability >= 5
			}
		}
		modifier = {
			add = 8
			desc = planet_stability_low
			target = {
				planet_stability < 5
			}
		}
		modifier = {
			add = -1
			desc = planet_stability_high
			target = {
				planet_stability > 50
				planet_stability <= 55
			}
		}
		modifier = {
			add = -2
			desc = planet_stability_high
			target = {
				planet_stability > 55
				planet_stability <= 60
			}
		}
		modifier = {
			add = -3
			desc = planet_stability_high
			target = {
				planet_stability > 60
				planet_stability <= 65
			}
		}
		modifier = {
			add = -4
			desc = planet_stability_high
			target = {
				planet_stability > 65
				planet_stability <= 70
			}
		}
		modifier = {
			add = -5
			desc = planet_stability_high
			target = {
				planet_stability > 70
				planet_stability <= 75
			}
		}
		modifier = {
			add = -6
			desc = planet_stability_high
			target = {
				planet_stability > 75
				planet_stability <= 80
			}
		}
		modifier = {
			add = -7
			desc = planet_stability_high
			target = {
				planet_stability > 80
				planet_stability <= 85
			}
		}
		modifier = {
			add = -8
			desc = planet_stability_high
			target = {
				planet_stability > 85
				planet_stability <= 90
			}
		}
		modifier = {
			add = -9
			desc = planet_stability_high
			target = {
				planet_stability > 90
				planet_stability <= 95
			}
		}
		modifier = {
			add = -10
			desc = planet_stability_high
			target = {
				planet_stability > 95
			}
		}
		modifier = {
			factor = 0
			desc = HAS_GROUND_COMBAT
			target = {
				has_ground_combat = yes
			}
		}
		modifier = {
			factor = 0
			desc = TRIGGER_IS_IN_COMBAT
			exists = target.solar_system.starbase
			target.solar_system.starbase.fleet = {
				is_in_combat = yes
			}
		}
		modifier = {
			factor = 0.5
			desc = mmgsiege_siege_approach_defender_propaganda
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_defender_situation
					current_situation_approach = mmgsiege_siege_approach_defender_propaganda
				}
			}
		}
		modifier = {
			add = 4
			desc = mmgsiege_siege_approach_attacker_propaganda
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_attacker_situation
					current_situation_approach = mmgsiege_siege_approach_attacker_propaganda
				}
			}
		}
		modifier = {
			add = 0.5
			desc = mmgsiege_siege_approach_harsh_occupation
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_defender_situation
					current_situation_approach = mmgsiege_siege_approach_harsh_occupation
				}
			}
		}
	}
}

mmgsiege_siege_surrender_defender_situation = {
	picture = GFX_evt_fleet_from_surface
	category = negative
	fail_icon = GFX_situation_outcome_meh
	fail_icon_frame = GFX_situation_outcome_frame
	complete_icon = GFX_situation_outcome_negative
	complete_icon_frame = GFX_situation_outcome_frame_red
	abort_trigger = {
		OR = {
			target = {
				mmgsiege_planet_can_surrender = no
			}
			NOT = {
				target.controller = {
					is_same_value = root.owner
				}
			}
		}
	}
	on_monthly = {
		events = {
			mmgsiege.21
		}
	}
	on_fail = {
		destroy_situation = this
		target = {
			every_targeting_situation = {
				limit = { is_situation_type = mmgsiege_siege_surrender_attacker_situation }
				destroy_situation = this
			}
		}
	}
	on_progress_complete = {
		target = {
			hidden_effect = {
				remove_all_armies = yes
				if = {
					limit = {
						solar_system.starbase.owner = {
							is_at_war_with = root.target.owner
							any_war = {
								is_total_war = yes
								OR = {
									AND = {
										any_attacker = { is_same_value = prevprev }
										any_defender = { is_same_value = root.target.owner }
									}
									AND = {
										any_defender = { is_same_value = prevprev }
										any_attacker = { is_same_value = root.target.owner }
									}
								}
							}
						}
					}
					set_owner = solar_system.starbase.controller
					solar_system.starbase = {
						set_owner = controller
					}
				}
			}
			set_controller = solar_system.starbase.controller
		}
		hidden_effect = {
			owner = {
				country_event = {
					id = mmgsiege.2
					scopes = {
						from = root.target
						fromfrom = root.target.starbase.controller
					}
				}
			}
			target.solar_system.starbase.controller = {
				country_event = {
					id = mmgsiege.3
					scopes = {
						from = root.target
						fromfrom = root.owner
					}
				}
			}
		}
		destroy_situation = this
		hidden_effect = {
			target = {
				every_targeting_situation = {
					limit = { is_situation_type = mmgsiege_siege_surrender_attacker_situation }
					destroy_situation = this
				}
			}
		}
	}
	stages = {
		mmgsiege_siege_surrender_situation_stage_1 = {
			end = 25
			icon = GFX_situation_stage_1
			icon_background = GFX_situation_stage_frame_red
		}
		mmgsiege_siege_surrender_situation_stage_2 = {
			end = 50
			icon = GFX_situation_stage_2
			icon_background = GFX_situation_stage_frame_red
		}
		mmgsiege_siege_surrender_situation_stage_3 = {
			end = 75
			icon = GFX_situation_stage_3
			icon_background = GFX_situation_stage_frame_red
		}
		mmgsiege_siege_surrender_situation_stage_4 = {
			end = 100
			icon = GFX_situation_stage_4
			icon_background = GFX_situation_stage_frame_red
		}
	}
	approach = {
		name = mmgsiege_siege_approach_do_nothing
		icon = GFX_situation_approach_this_is_fine
		icon_background = GFX_situation_approach_bg_yellow
		default = yes
		on_select = {
			custom_tooltip = mmgsiege_siege_approach_do_nothing
		}
		ai_weight = {
			weight = 10
		}
	}
	approach = {
		name = mmgsiege_siege_approach_defender_propaganda
		icon = GFX_situation_approach_unity
		icon_background = GFX_situation_approach_bg_green
		potential = {
			target.owner = {
				is_same_value = root.owner
			}
		}
		resources = {
			category = situations
			upkeep = {
				unity = 25
				trigger = {
					target = {
						num_pops < 10
					}
				}
			}
			upkeep = {
				unity = 50
				trigger = {
					target = {
						num_pops >= 10
						num_pops < 25
					}
				}
			}
			upkeep = {
				unity = 75
				trigger = {
					target = {
						num_pops >= 25
						num_pops < 50
					}
				}
			}
			upkeep = {
				unity = 100
				trigger = {
					target = {
						num_pops >= 50
					}
				}
			}
		}
		on_select = {
			custom_tooltip = mmgsiege_siege_approach_defender_propaganda_tooltip
		}
		ai_weight = {
			weight = 5
			modifier = {
				add = 10
				target.solar_system.starbase.controller = {
					has_claim = root.target.solar_system
				}
			}
			modifier = {
				factor = 0
				owner = {
					has_deficit = unity
				}
			}
		}
	}
	approach = {
		name = mmgsiege_siege_approach_harsh_occupation
		icon = GFX_situation_approach_sword
		icon_background = GFX_situation_approach_bg_red
		potential = {
			target.owner = {
				NOT = { is_same_value = root.owner }
			}
		}
		modifier = {
			diplo_weight_mult = -0.1
		}
		on_select = {
			custom_tooltip = mmgsiege_siege_approach_harsh_occupation_tooltip
			target = {
				add_planet_devastation = 40
			}
		}
		ai_weight = {
			weight = 4
			modifier = {
				add = 8
				owner = {
					has_claim = root.target.solar_system
				}
			}
			modifier = {
				add = 4
				owner = { is_militarist = yes }
			}
			modifier = {
				add = 4
				owner = { has_ethic = ethic_fanatic_militarist }
			}
			modifier = {
				add = 4
				owner = { is_xenophobe = yes }
			}
			modifier = {
				add = 4
				owner = { has_ethic = ethic_fanatic_xenophobe }
			}
			modifier = {
				add = -4
				owner = { is_pacifist = yes }
			}
			modifier = {
				add = -4
				owner = { has_ethic = ethic_fanatic_pacifist }
			}
			modifier = {
				add = -4
				owner = { is_xenophile = yes }
			}
			modifier = {
				add = -4
				owner = { has_ethic = ethic_fanatic_xenophile }
			}
		}
	}
	monthly_progress = {
		base = 0
		modifier = {
			add = 1
			desc = planet_stability_low
			target = {
				planet_stability < 40
				planet_stability >= 35
			}
		}
		modifier = {
			add = 2
			desc = planet_stability_low
			target = {
				planet_stability < 35
				planet_stability >= 30
			}
		}
		modifier = {
			add = 3
			desc = planet_stability_low
			target = {
				planet_stability < 30
				planet_stability >= 25
			}
		}
		modifier = {
			add = 4
			desc = planet_stability_low
			target = {
				planet_stability < 25
				planet_stability >= 20
			}
		}
		modifier = {
			add = 5
			desc = planet_stability_low
			target = {
				planet_stability < 20
				planet_stability >= 15
			}
		}
		modifier = {
			add = 6
			desc = planet_stability_low
			target = {
				planet_stability < 15
				planet_stability >= 10
			}
		}
		modifier = {
			add = 7
			desc = planet_stability_low
			target = {
				planet_stability < 10
				planet_stability >= 5
			}
		}
		modifier = {
			add = 8
			desc = planet_stability_low
			target = {
				planet_stability < 5
			}
		}
		modifier = {
			add = -1
			desc = planet_stability_high
			target = {
				planet_stability > 50
				planet_stability <= 55
			}
		}
		modifier = {
			add = -2
			desc = planet_stability_high
			target = {
				planet_stability > 55
				planet_stability <= 60
			}
		}
		modifier = {
			add = -3
			desc = planet_stability_high
			target = {
				planet_stability > 60
				planet_stability <= 65
			}
		}
		modifier = {
			add = -4
			desc = planet_stability_high
			target = {
				planet_stability > 65
				planet_stability <= 70
			}
		}
		modifier = {
			add = -5
			desc = planet_stability_high
			target = {
				planet_stability > 70
				planet_stability <= 75
			}
		}
		modifier = {
			add = -6
			desc = planet_stability_high
			target = {
				planet_stability > 75
				planet_stability <= 80
			}
		}
		modifier = {
			add = -7
			desc = planet_stability_high
			target = {
				planet_stability > 80
				planet_stability <= 85
			}
		}
		modifier = {
			add = -8
			desc = planet_stability_high
			target = {
				planet_stability > 85
				planet_stability <= 90
			}
		}
		modifier = {
			add = -9
			desc = planet_stability_high
			target = {
				planet_stability > 90
				planet_stability <= 95
			}
		}
		modifier = {
			add = -10
			desc = planet_stability_high
			target = {
				planet_stability > 95
			}
		}
		modifier = {
			factor = 0
			desc = HAS_GROUND_COMBAT
			target = {
				has_ground_combat = yes
			}
		}
		modifier = {
			factor = 0
			desc = TRIGGER_IS_IN_COMBAT
			exists = target.solar_system.starbase
			target.solar_system.starbase.fleet = {
				is_in_combat = yes
			}
		}
		modifier = {
			factor = 0.5
			desc = mmgsiege_siege_approach_defender_propaganda
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_defender_situation
					current_situation_approach = mmgsiege_siege_approach_defender_propaganda
				}
			}
		}
		modifier = {
			add = 4
			desc = mmgsiege_siege_approach_attacker_propaganda
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_attacker_situation
					current_situation_approach = mmgsiege_siege_approach_attacker_propaganda
				}
			}
		}
		modifier = {
			add = 0.5
			desc = mmgsiege_siege_approach_harsh_occupation
			target = {
				any_targeting_situation = {
					is_situation_type = mmgsiege_siege_surrender_defender_situation
					current_situation_approach = mmgsiege_siege_approach_harsh_occupation
				}
			}
		}
	}
}
